<!DOCTYPE html>
<html lang="hu">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Névnap naptár</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-gray-950 text-gray-100">
    <div class="max-w-2xl mx-auto p-6">
      <h1 class="text-2xl font-semibold mb-6">Névnap-naptár</h1>

      <div class="bg-blue-900/20 border border-blue-800/30 rounded-lg p-3 mb-6">
        <p class="text-sm text-blue-200">
          Válaszd ki a neveket, amiket szertetnel látni a naptárban. Kapsz egy naptár linket, amit
          gyorsan hozzáadhatsz bármilyen naptár apphoz
        </p>
      </div>

      <div class="bg-gray-900/60 border border-gray-800 rounded-xl p-4">
        <label class="block text-xs uppercase tracking-wide text-gray-400 mb-2"
          >Név hozzáadása</label
        >
        <div class="relative">
          <input
            id="input"
            type="text"
            placeholder="Kezdj el gépelni…"
            class="w-full bg-gray-900 border border-gray-800 rounded-lg px-3 py-2 text-gray-100 placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500/60"
          />
          <ul
            id="suggestions"
            class="absolute z-10 mt-1 w-full bg-gray-900 border border-gray-800 rounded-lg shadow-xl max-h-64 overflow-auto hidden"
          ></ul>
        </div>

        <div class="mt-4">
          <div class="flex items-center justify-between mb-2">
            <span class="text-xs uppercase tracking-wide text-gray-400">Kiválasztott nevek</span>
            <label class="flex items-center gap-2 text-xs text-gray-400">
              <input
                id="mainOnly"
                type="checkbox"
                checked
                class="rounded bg-gray-800 border-gray-700 text-blue-600"
              />
              Csak fő névnapok
            </label>
          </div>
          <div id="chips" class="flex flex-wrap gap-2"></div>
          <div class="mt-4">
            <label class="block text-xs uppercase tracking-wide text-gray-400 mb-1"
              >Emlékeztetők</label
            >
            <div class="flex items-center gap-2 mb-2">
              <select
                id="reminderDays"
                class="bg-gray-900 border border-gray-800 rounded px-2 py-1 text-xs text-gray-100"
              >
                <option value="1">1 nappal</option>
                <option value="2">2 nappal</option>
                <option value="7">1 héttel</option>
              </select>
              <span class="text-xs text-gray-400">előtte</span>
              <input
                id="reminderTime"
                type="time"
                value="12:00"
                class="bg-gray-900 border border-gray-800 rounded px-2 py-1 text-xs text-gray-100"
              />
              <button
                id="addReminder"
                class="bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-500"
              >
                +
              </button>
            </div>
            <div id="reminderList" class="flex flex-wrap gap-1"></div>
          </div>
        </div>

        <div class="mt-6 flex gap-3 items-center">
          <a
            id="link"
            href="#"
            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-500"
            target="_blank"
            >Feliratkozás a naptárra</a
          >
          <button id="copy" class="bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
            Másolás
          </button>
          <span id="status" class="text-sm text-gray-400"></span>
        </div>

        <div
          id="mobileHelp"
          class="mt-3 p-3 bg-yellow-900/20 border border-yellow-800/30 rounded-lg text-xs text-yellow-200 hidden"
        >
          <strong>Android:</strong> A fájl le fog tölteni. Nyomj a meginytásra, majd válaszd a
          "Naptár" alkalmazást.
        </div>

        <pre
          id="preview"
          class="mt-3 text-xs bg-gray-900 border border-gray-800 p-3 rounded break-all"
        ></pre>
      </div>

      <footer class="mt-8 text-center">
        <p class="text-xs text-gray-500">
          made by
          <a href="https://sonacl.xyz" class="text-blue-400 hover:text-blue-300" target="_blank"
            >SoNaCl</a
          >
        </p>
      </footer>
    </div>

    <script>
      const input = document.getElementById('input');
      const suggestions = document.getElementById('suggestions');
      const chips = document.getElementById('chips');
      const link = document.getElementById('link');
      const copy = document.getElementById('copy');
      const status = document.getElementById('status');
      const preview = document.getElementById('preview');
      const mainOnly = document.getElementById('mainOnly');
      const reminderDays = document.getElementById('reminderDays');
      const reminderTime = document.getElementById('reminderTime');
      const addReminder = document.getElementById('addReminder');
      const reminderList = document.getElementById('reminderList');
      const selected = new Set();
      const reminders = new Set(['2160']);
      function updateLink() {
        const names = [...selected];
        const url = new URL('/calendar.ics', location.origin);
        if (names.length) {
          url.searchParams.set('subscribednames', names.join(','));
          if (mainOnly.checked) url.searchParams.set('mainonly', 'true');
          if (reminders.size) url.searchParams.set('reminders', [...reminders].join(','));
        }
        link.href = url;
        preview.textContent = url;
      }

      function renderReminders() {
        reminderList.innerHTML = '';
        [...reminders].forEach((minutes) => {
          let text = '';
          if (minutes >= 1440) {
            const days = Math.floor(minutes / 1440);
            const remainingMins = minutes - days * 1440;
            const hours = Math.floor(remainingMins / 60);
            const mins = remainingMins % 60;
            text = `${days} nappal előtte ${hours.toString().padStart(2, '0')}:${mins
              .toString()
              .padStart(2, '0')}-kor`;
          } else {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            text = `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}-kor`;
          }

          const chip = document.createElement('span');
          chip.className =
            'inline-flex items-center bg-green-500/10 text-green-300 px-2 py-1 rounded text-xs border border-green-500/20';
          chip.innerHTML = `${text} <button class="ml-1 text-green-300 hover:text-green-200" onclick="removeReminder('${minutes}')">×</button>`;
          reminderList.appendChild(chip);
        });
      }

      function removeReminder(minutes) {
        reminders.delete(minutes);
        renderReminders();
        updateLink();
      }

      addReminder.addEventListener('click', () => {
        const days = parseInt(reminderDays.value);
        const [hours, mins] = reminderTime.value.split(':').map(Number);
        const totalMinutes = days * 1440 + hours * 60 + mins;
        reminders.add(totalMinutes.toString());
        renderReminders();
        updateLink();
      });

      function renderChips() {
        chips.innerHTML = '';
        [...selected].forEach((name) => {
          const chip = document.createElement('span');
          chip.className =
            'inline-flex items-center bg-blue-500/10 text-blue-300 px-2 py-1 rounded-full text-sm border border-blue-500/20';
          chip.innerHTML = `${name} <button class="ml-1 text-blue-300 hover:text-blue-200" onclick="remove('${name}')">×</button>`;
          chips.appendChild(chip);
        });
      }

      function remove(name) {
        selected.delete(name);
        renderChips();
        updateLink();
      }

      async function search(q) {
        const url = new URL('/names', location.origin);
        if (q) url.searchParams.set('q', q);
        return (await fetch(url)).json();
      }

      function showSuggestions(names) {
        suggestions.innerHTML = names
          .map(
            (name) =>
              `<li class="px-3 py-2 hover:bg-gray-800 cursor-pointer" onclick="add('${name}')">${name}</li>`,
          )
          .join('');
        suggestions.classList.toggle('hidden', !names.length);
      }

      function add(name) {
        selected.add(name);
        renderChips();
        updateLink();
        input.value = '';
        suggestions.classList.add('hidden');
      }

      let timer;
      input.addEventListener('input', () => {
        clearTimeout(timer);
        const q = input.value.trim();
        if (!q) return suggestions.classList.add('hidden');
        timer = setTimeout(async () => {
          const names = await search(q);
          showSuggestions(names.filter((n) => !selected.has(n)));
        }, 200);
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && input.value.trim()) {
          add(input.value.trim());
        }
      });

      document.addEventListener('click', (e) => {
        if (!suggestions.contains(e.target) && e.target !== input) {
          suggestions.classList.add('hidden');
        }
      });

      copy.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(link.href);
          status.textContent = 'Másolva';
          setTimeout(() => (status.textContent = ''), 2000);
        } catch {
          status.textContent = 'Hiba';
          setTimeout(() => (status.textContent = ''), 2000);
        }
      });

      const isAndroidChrome = /Android.*Chrome/.test(navigator.userAgent);
      if (isAndroidChrome) {
        document.getElementById('mobileHelp').classList.remove('hidden');
      }

      mainOnly.addEventListener('change', updateLink);
      renderReminders();
      updateLink();
    </script>
  </body>
</html>
